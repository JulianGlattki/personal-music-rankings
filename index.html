<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Music Rankings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d0d0d;
      --surface: #141414;
      --surface2: #1c1c1c;
      --border: #2a2a2a;
      --accent: #c8a96e;
      --accent2: #e8d5b0;
      --text: #e8e4dc;
      --muted: #6b6560;
      --sidebar-w: 240px;
      --header-h: 64px;
    }

    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 9999;
      opacity: 0.5;
    }

    /* ══ HEADER ══ */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--header-h);
      background: rgba(13,13,13,0.94);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      gap: 1rem;
      z-index: 200;
    }

    .hamburger {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.4rem;
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex-shrink: 0;
    }

    .hamburger span {
      display: block;
      width: 20px;
      height: 1.5px;
      background: var(--muted);
      transition: all 0.25s;
    }

    .hamburger:hover span { background: var(--accent); }

    .site-logo {
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      font-weight: 900;
      letter-spacing: -0.02em;
      color: var(--accent2);
      cursor: pointer;
      text-decoration: none;
    }

    .breadcrumb {
      font-size: 0.65rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .breadcrumb .sep { color: var(--border); }
    .breadcrumb .crumb-active { color: var(--accent); }

    /* ══ SIDEBAR ══ */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 150;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .sidebar-overlay.open { opacity: 1; pointer-events: all; }

    aside {
      position: fixed;
      top: 0; left: 0;
      width: var(--sidebar-w);
      height: 100vh;
      background: #111;
      border-right: 1px solid var(--border);
      z-index: 160;
      display: flex;
      flex-direction: column;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
      overflow-y: auto;
    }

    aside.open { transform: translateX(0); }
    aside::-webkit-scrollbar { width: 2px; }
    aside::-webkit-scrollbar-thumb { background: var(--border); }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.25rem 1rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .sidebar-title {
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .sidebar-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      padding: 0.2rem;
      transition: color 0.15s;
    }

    .sidebar-close:hover { color: var(--accent); }

    .sidebar-home-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--muted);
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      padding: 0.9rem 1.25rem;
      border-bottom: 1px solid var(--border);
      transition: color 0.15s, background 0.15s;
    }

    .sidebar-home-link:hover { color: var(--accent2); background: rgba(200,169,110,0.05); }

    .sidebar-group { border-bottom: 1px solid var(--border); }

    .sidebar-group-trigger {
      width: 100%;
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.85rem 1.25rem;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.75rem;
      letter-spacing: 0.06em;
      text-align: left;
      transition: background 0.15s, color 0.15s;
    }

    .sidebar-group-trigger:hover { background: rgba(200,169,110,0.05); color: var(--accent2); }
    .sidebar-group-trigger.active { color: var(--accent); }

    .sidebar-group-trigger .chevron {
      margin-left: auto;
      font-size: 0.6rem;
      color: var(--muted);
      transition: transform 0.2s;
    }

    .sidebar-group-trigger.expanded .chevron { transform: rotate(90deg); }

    .sidebar-sub {
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease;
    }

    .sidebar-sub.open { max-height: 300px; }

    .sidebar-sub a {
      display: block;
      text-decoration: none;
      color: var(--muted);
      font-size: 0.68rem;
      letter-spacing: 0.05em;
      padding: 0.5rem 1.25rem 0.5rem 2.8rem;
      transition: color 0.15s, background 0.15s;
      border-left: 2px solid transparent;
    }

    .sidebar-sub a:hover { color: var(--accent2); background: rgba(200,169,110,0.05); }
    .sidebar-sub a.active { color: var(--accent); border-left-color: var(--accent); }

    /* ══ PAGES ══ */
    .page {
      display: none;
      padding-top: var(--header-h);
      min-height: 100vh;
    }

    .page.active {
      display: block;
      animation: fadeUp 0.35s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ══ HOME HERO ══ */
    .home-hero {
      padding: 5rem 4rem 3.5rem;
      border-bottom: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .home-hero::after {
      content: 'MUSIC';
      position: absolute;
      right: -1rem; top: 50%;
      transform: translateY(-50%);
      font-family: 'Playfair Display', serif;
      font-size: clamp(6rem, 18vw, 18rem);
      font-weight: 900;
      color: transparent;
      -webkit-text-stroke: 1px rgba(200,169,110,0.06);
      pointer-events: none;
      line-height: 1;
      white-space: nowrap;
    }

    .home-hero h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(2.2rem, 6vw, 5rem);
      font-weight: 900;
      line-height: 0.95;
      letter-spacing: -0.03em;
    }

    .home-hero h1 em { font-style: italic; color: var(--accent); }

    .home-hero p {
      margin-top: 1.5rem;
      color: var(--muted);
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      max-width: 38ch;
    }

    /* ══ HOME GRID ══ */
    .home-grid {
      padding: 2.5rem 4rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1px;
      background: var(--border);
      border-top: 1px solid var(--border);
    }

    /* loading state */
    .loading-card {
      background: var(--surface);
      padding: 2rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--muted);
      font-size: 0.7rem;
      letter-spacing: 0.08em;
    }

    .loading-spinner {
      width: 14px; height: 14px;
      border: 1.5px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .preview-card {
      background: var(--surface);
      padding: 2rem 2rem 1.5rem;
      transition: background 0.15s;
    }

    .preview-card:hover { background: var(--surface2); }

    .preview-cat-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .preview-cat-icon { font-size: 1.3rem; }

    .preview-cat-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      font-weight: 900;
      letter-spacing: -0.02em;
    }

    .preview-top3 {
      display: flex;
      flex-direction: column;
      margin-bottom: 1.25rem;
    }

    .preview-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0;
      border-bottom: 1px solid rgba(42,42,42,0.6);
    }

    .preview-row:last-child { border-bottom: none; }

    .preview-rank {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      font-weight: 900;
      min-width: 2rem;
      text-align: right;
      line-height: 1;
      flex-shrink: 0;
      color: rgba(200,169,110,0.18);
    }

    .preview-rank.gold   { color: rgba(255,210,80,0.55); }
    .preview-rank.silver { color: rgba(185,185,190,0.45); }
    .preview-rank.bronze { color: rgba(205,127,50,0.45); }

    .preview-cover {
      width: 38px; height: 38px;
      object-fit: cover;
      border-radius: 2px;
      flex-shrink: 0;
      background: var(--border);
    }

    .preview-info { flex: 1; min-width: 0; }

    .preview-title {
      font-family: 'Playfair Display', serif;
      font-size: 0.88rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .preview-artist {
      font-size: 0.64rem;
      color: var(--muted);
      margin-top: 0.1rem;
    }

    .preview-year {
      font-size: 0.6rem;
      color: var(--accent);
      letter-spacing: 0.08em;
      flex-shrink: 0;
    }

    .preview-card-footer {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .read-more-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.64rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--accent);
      background: none;
      border: 1px solid rgba(200,169,110,0.3);
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-family: 'DM Mono', monospace;
      transition: all 0.15s;
      text-decoration: none;
    }

    .read-more-btn:hover {
      background: rgba(200,169,110,0.08);
      border-color: var(--accent);
      color: var(--accent2);
    }

    /* Spotify playlist button */
    .playlist-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.62rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #1DB954;
      background: none;
      border: 1px solid rgba(29,185,84,0.25);
      padding: 0.5rem 0.85rem;
      cursor: pointer;
      font-family: 'DM Mono', monospace;
      text-decoration: none;
      transition: all 0.15s;
    }

    .playlist-btn:hover {
      background: rgba(29,185,84,0.08);
      border-color: #1DB954;
    }

    .playlist-btn svg {
      width: 11px; height: 11px;
      fill: #1DB954;
      flex-shrink: 0;
    }

    /* ══ DETAIL HERO ══ */
    .detail-hero {
      padding: 3.5rem 4rem 2.5rem;
      border-bottom: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.64rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      background: none;
      border: none;
      cursor: pointer;
      font-family: 'DM Mono', monospace;
      padding: 0;
      margin-bottom: 1.5rem;
      transition: color 0.15s;
    }

    .back-btn:hover { color: var(--accent); }

    .detail-bg-text {
      position: absolute;
      right: -1rem; top: 50%;
      transform: translateY(-50%);
      font-family: 'Playfair Display', serif;
      font-size: clamp(5rem, 14vw, 14rem);
      font-weight: 900;
      color: transparent;
      -webkit-text-stroke: 1px rgba(200,169,110,0.06);
      pointer-events: none;
      line-height: 1;
      white-space: nowrap;
    }

    .detail-hero-top {
      display: flex;
      align-items: flex-end;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .detail-hero h2 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(2rem, 6vw, 4.5rem);
      font-weight: 900;
      line-height: 0.95;
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* ══ DETAIL CONTENT ══ */
    .detail-content { padding: 2.5rem 4rem; }

    .section-label {
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 1.25rem;
    }

    .ranked-list {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
      margin-bottom: 3rem;
    }

    .album-row {
      background: var(--surface);
      display: flex;
      align-items: stretch;
      transition: background 0.15s;
    }

    .album-row:hover { background: var(--surface2); }

    .album-rank-col {
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid var(--border);
      padding: 1.25rem 0.5rem;
      min-width: 60px;
      flex-shrink: 0;
    }

    .album-rank-num {
      font-family: 'Playfair Display', serif;
      font-size: 1.6rem;
      font-weight: 900;
      color: rgba(200,169,110,0.18);
      line-height: 1;
      transition: color 0.15s;
    }

    .album-row:hover .album-rank-num { color: rgba(200,169,110,0.45); }
    .album-rank-num.gold   { color: rgba(255,210,80,0.5) !important; }
    .album-rank-num.silver { color: rgba(185,185,190,0.4) !important; }
    .album-rank-num.bronze { color: rgba(205,127,50,0.4) !important; }

    .album-cover-col {
      width: 80px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      background: var(--surface2);
      overflow: hidden;
    }

    .album-cover {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .album-main-col { padding: 1.25rem 1.5rem; flex: 1; min-width: 0; }

    .album-row-title {
      font-family: 'Playfair Display', serif;
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 0.2rem;
    }

    .album-row-artist { font-size: 0.7rem; color: var(--muted); margin-bottom: 0.25rem; }
    .album-row-year   { font-size: 0.6rem; color: var(--accent); letter-spacing: 0.1em; margin-bottom: 0.75rem; }

    .spotify-embed iframe { border-radius: 4px; border: none; display: block; }

    .spotify-link {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.62rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #1DB954;
      text-decoration: none;
      opacity: 0.75;
      transition: opacity 0.15s;
    }

    .spotify-link:hover { opacity: 1; }

    .hm-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
    }

    .hm-card {
      background: var(--surface);
      padding: 1rem 1.25rem;
      transition: background 0.15s;
    }

    .hm-card:hover { background: var(--surface2); }
    .hm-title { font-family: 'Playfair Display', serif; font-size: 0.85rem; font-weight: 700; margin-bottom: 0.2rem; }
    .hm-artist { font-size: 0.65rem; color: var(--muted); margin-bottom: 0.4rem; }
    .hm-link { font-size: 0.6rem; color: #1DB954; text-decoration: none; opacity: 0.7; transition: opacity 0.15s; }
    .hm-link:hover { opacity: 1; }

    /* ══ FOOTER ══ */
    footer {
      border-top: 1px solid var(--border);
      padding: 1.75rem 4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4rem;
    }

    footer p { font-size: 0.62rem; color: var(--muted); letter-spacing: 0.08em; }

    /* ══ RESPONSIVE ══ */
    @media (max-width: 700px) {
      .home-hero, .detail-hero, .detail-content { padding-left: 1.5rem; padding-right: 1.5rem; }
      .home-grid { padding: 0; grid-template-columns: 1fr; }
      footer { padding: 1.25rem 1.5rem; flex-direction: column; gap: 0.5rem; text-align: center; }
    }
  </style>
</head>
<body>

<!-- ══ HEADER ══ -->
<header>
  <button class="hamburger" id="hamburger-btn" aria-label="Open menu">
    <span></span><span></span><span></span>
  </button>
  <a class="site-logo" href="#" onclick="showHome(); return false;">My Music Rankings</a>
  <div class="breadcrumb" id="breadcrumb"></div>
</header>

<!-- ══ SIDEBAR ══ -->
<div class="sidebar-overlay" id="sidebar-overlay"></div>
<aside id="sidebar">
  <div class="sidebar-header">
    <span class="sidebar-title">Categories</span>
    <button class="sidebar-close" id="sidebar-close-btn">✕</button>
  </div>
  <a class="sidebar-home-link" href="#" onclick="showHome(); closeSidebar(); return false;">⌂ &nbsp;Home — All Categories</a>
  <div id="sidebar-cats"></div>
</aside>

<!-- ══ HOME PAGE ══ -->
<div class="page active" id="page-home">
  <div class="home-hero">
    <h1>Good Music,<br><em>Ranked.</em></h1>
    <p>Personal rankings across albums, tracks &amp; composers — curated and always expanding.</p>
  </div>
  <div class="home-grid" id="home-grid">
    <!-- filled by JS after CSV loads -->
  </div>
  <footer>
    <p>Curated with taste. Updated whenever.</p>
    <p style="color:var(--accent);font-size:0.62rem;letter-spacing:0.1em;">♫ MY MUSIC RANKINGS</p>
  </footer>
</div>

<!-- ══ DETAIL PAGE ══ -->
<div class="page" id="page-detail">
  <div class="detail-hero" id="detail-hero"></div>
  <div class="detail-content" id="detail-content"></div>
  <footer>
    <p>Curated with taste. Updated whenever.</p>
    <p style="color:var(--accent);font-size:0.62rem;letter-spacing:0.1em;">♫ MY MUSIC RANKINGS</p>
  </footer>
</div>

<!-- ══════════════════════════════════════════════════════════════════
  All categories are defined in playlists.json — edit that file instead.
  The website loads it automatically on startup.
══════════════════════════════════════════════════════════════════ -->
<script>
// CATEGORIES is populated at runtime from playlists.json — see init block below
let CATEGORIES = [];
</script>

<!-- ══ RENDER ENGINE ══ -->
<script>
// ── Spotify helpers ──────────────────────────────────────────────────────────
const spotifyEmbedUrl = (id, type = 'album') =>
  `https://open.spotify.com/embed/${type}/${id}?utm_source=generator&theme=0`;
const spotifyOpenUrl = (id, type = 'album') =>
  `https://open.spotify.com/${type}/${id}`;

const rankClass = r => r === 1 ? 'gold' : r === 2 ? 'silver' : r === 3 ? 'bronze' : '';

const SPOTIFY_ICON = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>`;

// ── CSV parser ───────────────────────────────────────────────────────────────
function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.trim());
  return lines.slice(1).map(line => {
    // Handle commas inside quoted fields
    const values = [];
    let cur = '', inQ = false;
    for (const ch of line) {
      if (ch === '"') { inQ = !inQ; }
      else if (ch === ',' && !inQ) { values.push(cur.trim()); cur = ''; }
      else { cur += ch; }
    }
    values.push(cur.trim());
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] ?? '');
    return obj;
  });
}

function csvRowToEntry(row) {
  return {
    title:     row.title_override || row.title || '',
    artist:    row.artist    || '',
    year:      row.year_override || row.year_spotify || '',
    spotifyId: row.spotifyId || '',
    type:      row.type      || 'album',
    embed:     row.embed === 'true',
    cover:     row.cover     || '',
    playlist_url: row.playlist_url || '',
  };
}

// ── Load a category's entries (CSV or inline) ────────────────────────────────
async function loadCategory(cat) {
  if (cat.src) {
    try {
      const resp = await fetch(cat.src);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const text = await resp.text();
      const rows = parseCSV(text);
      cat._entries = rows.map(csvRowToEntry);
      cat._playlistUrl = rows[0]?.playlist_url || '';
    } catch (e) {
      console.warn(`Could not load ${cat.src}:`, e);
      cat._entries = [];
      cat._playlistUrl = '';
    }
  } else {
    // inline top: [...] — normalise to same shape
    cat._entries = (cat.top || []).map(a => ({
      title:     a.title     || '',
      artist:    a.artist    || '',
      year:      a.year      || '',
      spotifyId: a.spotifyId || '',
      type:      a.type      || (cat.type === 'tracks' ? 'track' : 'album'),
      embed:     a.embed !== false,
      cover:     a.cover     || '',
      playlist_url: '',
    }));
    cat._playlistUrl = '';
  }
}

// ── Playlist button ──────────────────────────────────────────────────────────
function playlistBtn(url) {
  if (!url) return '';
  return `<a class="playlist-btn" href="${url}" target="_blank" rel="noopener">
    ${SPOTIFY_ICON} Open Playlist
  </a>`;
}

// ── Media block ──────────────────────────────────────────────────────────────
function buildMedia(entry) {
  const sType = entry.type || 'album';
  const embedH = sType === 'track' ? 152 : 80;
  if (entry.spotifyId && entry.embed)
    return `<div class="spotify-embed"><iframe src="${spotifyEmbedUrl(entry.spotifyId, sType)}" width="100%" height="${embedH}" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe></div>`;
  if (entry.spotifyId)
    return `<a class="spotify-link" href="${spotifyOpenUrl(entry.spotifyId, sType)}" target="_blank" rel="noopener">▶ Open on Spotify</a>`;
  if (entry.link)
    return `<a class="spotify-link" href="${entry.link}" target="_blank" rel="noopener">▶ Listen</a>`;
  return '';
}

// ── Build sidebar ────────────────────────────────────────────────────────────
function buildSidebar() {
  const container = document.getElementById('sidebar-cats');
  CATEGORIES.forEach(cat => {
    const group = document.createElement('div');
    group.className = 'sidebar-group';
    group.id = `sidebar-group-${cat.id}`;

    const trigger = document.createElement('button');
    trigger.className = 'sidebar-group-trigger';
    trigger.id = `sidebar-trigger-${cat.id}`;
    trigger.innerHTML = `<span>${cat.icon}</span><span>${cat.name}</span><span class="chevron">▶</span>`;

    const sub = document.createElement('div');
    sub.className = 'sidebar-sub';

    const fullLink = document.createElement('a');
    fullLink.href = '#';
    fullLink.textContent = `Full Top ${cat._entries?.length ?? '…'}`;
    fullLink.onclick = e => { e.preventDefault(); showDetail(cat.id); closeSidebar(); };
    sub.appendChild(fullLink);

    trigger.onclick = () => {
      const isOpen = sub.classList.contains('open');
      container.querySelectorAll('.sidebar-sub').forEach(s => s.classList.remove('open'));
      container.querySelectorAll('.sidebar-group-trigger').forEach(t => t.classList.remove('expanded'));
      if (!isOpen) { sub.classList.add('open'); trigger.classList.add('expanded'); }
    };

    group.appendChild(trigger);
    group.appendChild(sub);
    container.appendChild(group);
  });
}

// ── Build home grid ──────────────────────────────────────────────────────────
function buildHome() {
  const grid = document.getElementById('home-grid');
  grid.innerHTML = CATEGORIES.map(cat => {
    const entries = cat._entries || [];
    const top3 = entries.slice(0, 3);

    const rows = top3.map((a, i) => {
      const rank = i + 1;
      return `
        <div class="preview-row">
          <div class="preview-rank ${rankClass(rank)}">${String(rank).padStart(2,'0')}</div>
          ${a.cover ? `<img class="preview-cover" src="${a.cover}" alt="${a.title}" loading="lazy">` : ''}
          <div class="preview-info">
            <div class="preview-title">${a.title}</div>
            <div class="preview-artist">${a.artist}</div>
          </div>
          ${a.year ? `<div class="preview-year">${a.year}</div>` : ''}
        </div>`;
    }).join('');

    return `
      <div class="preview-card">
        <div class="preview-cat-header">
          <span class="preview-cat-icon">${cat.icon}</span>
          <span class="preview-cat-name">${cat.name}</span>
        </div>
        <div class="preview-top3">${rows}</div>
        <div class="preview-card-footer">
          <button class="read-more-btn" onclick="showDetail('${cat.id}')">
            Full Top ${entries.length} &nbsp;→
          </button>
          ${playlistBtn(cat._playlistUrl)}
        </div>
      </div>`;
  }).join('');
}

// ── Show detail page ─────────────────────────────────────────────────────────
function showDetail(id) {
  const cat = CATEGORIES.find(c => c.id === id);
  if (!cat) return;

  const entries = cat._entries || [];
  const subtitle = cat.subtitle
    ? `<p style="margin-top:0.75rem;font-size:0.75rem;color:var(--muted);letter-spacing:0.05em;">${cat.subtitle}</p>`
    : '';

  document.getElementById('detail-hero').innerHTML = `
    <button class="back-btn" onclick="showHome()">← All Categories</button>
    <div class="detail-bg-text">${cat.icon}</div>
    <div class="detail-hero-top">
      <h2><span>${cat.icon}</span> ${cat.name}</h2>
      ${playlistBtn(cat._playlistUrl)}
    </div>
    ${subtitle}`;

  const ranked = entries.map((a, i) => {
    const rank = i + 1;
    const meta = a.meta
      ? `<div style="font-size:0.65rem;color:var(--muted);margin-bottom:0.5rem;font-style:italic;">${a.meta}</div>`
      : '';
    return `
      <div class="album-row">
        <div class="album-rank-col">
          <div class="album-rank-num ${rankClass(rank)}">${String(rank).padStart(2,'0')}</div>
        </div>
        ${a.cover ? `<div class="album-cover-col"><img class="album-cover" src="${a.cover}" alt="${a.title}" loading="lazy"></div>` : ''}
        <div class="album-main-col">
          <div class="album-row-title">${a.title}</div>
          <div class="album-row-artist">${a.artist}</div>
          ${meta}
          ${a.year ? `<div class="album-row-year">${a.year}</div>` : ''}
          ${buildMedia(a)}
        </div>
      </div>`;
  }).join('');

  let hmSection = '';
  if (cat.honorableMentions && cat.honorableMentions.length) {
    const cards = cat.honorableMentions.map(a => {
      const lnk = a.spotifyId
        ? `<a class="hm-link" href="${spotifyOpenUrl(a.spotifyId, a.type || 'album')}" target="_blank" rel="noopener">▶ Spotify</a>`
        : (a.link ? `<a class="hm-link" href="${a.link}" target="_blank" rel="noopener">▶ Listen</a>` : '');
      return `<div class="hm-card"><div class="hm-title">${a.title}</div><div class="hm-artist">${a.artist}${a.year ? ' · '+a.year : ''}</div>${lnk}</div>`;
    }).join('');
    hmSection = `<div class="section-label" style="margin-top:2.5rem;">Honorable Mentions</div><div class="hm-grid">${cards}</div>`;
  }

  document.getElementById('detail-content').innerHTML = `
    <div class="section-label">Top ${entries.length}</div>
    <div class="ranked-list">${ranked}</div>
    ${hmSection}`;

  document.getElementById('breadcrumb').innerHTML =
    `<span>All</span><span class="sep">/</span><span class="crumb-active">${cat.icon} ${cat.name}</span>`;

  document.querySelectorAll('.sidebar-group-trigger').forEach(t => t.classList.remove('active'));
  const trig = document.getElementById(`sidebar-trigger-${id}`);
  if (trig) trig.classList.add('active');

  switchPage('detail');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ── Show home ────────────────────────────────────────────────────────────────
function showHome() {
  document.getElementById('breadcrumb').innerHTML = '';
  document.querySelectorAll('.sidebar-group-trigger').forEach(t => t.classList.remove('active'));
  switchPage('home');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ── Switch page ──────────────────────────────────────────────────────────────
function switchPage(name) {
  document.querySelectorAll('.page').forEach(p => {
    p.classList.remove('active');
    p.style.animation = 'none';
  });
  const target = document.getElementById(`page-${name}`);
  target.offsetHeight;
  target.style.animation = '';
  target.classList.add('active');
}

// ── Init — load playlists.json, then all CSVs in parallel, then render ─────────
(async () => {
  const grid = document.getElementById('home-grid');

  // 1. Load playlists.json (single source of truth for categories)
  try {
    const resp = await fetch('playlists.json');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    CATEGORIES = await resp.json();
    // Derive src from id if not set
    CATEGORIES.forEach(cat => {
      if (!cat.src) cat.src = `data/${cat.id}.csv`;
    });
  } catch (e) {
    console.error('Could not load playlists.json:', e);
    grid.innerHTML = `<div class="loading-card" style="color:var(--accent)">
      Could not load playlists.json — check the file exists in your repo.
    </div>`;
    return;
  }

  // 2. Show loading placeholders (now we know the category names)
  grid.innerHTML = CATEGORIES.map(cat => `
    <div class="loading-card">
      <div class="loading-spinner"></div>
      <span>${cat.icon} ${cat.name}</span>
    </div>`).join('');

  buildSidebar();

  // 3. Load all CSVs in parallel
  await Promise.all(CATEGORIES.map(loadCategory));

  // 4. Update sidebar counts
  CATEGORIES.forEach(cat => {
    const link = document.querySelector(`#sidebar-group-${cat.id} .sidebar-sub a`);
    if (link) link.textContent = `Full Top ${cat._entries?.length ?? 0}`;
  });

  buildHome();
})();
</script>
</body>
</html>
